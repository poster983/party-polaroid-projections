<!-- <!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Image Uploader</title>
</head>
<body>
  <h1>Image Uploader</h1>

  <div id="signup">
    <label for="name">Name:</label>
    <input type="text" id="name">
    <button id="signupBtn">Sign up</button>
  </div>

  <div id="upload" style="display: none;">
    <input type="file" id="image" accept="image/*">
    <label for="caption">Caption:</label>
    <input type="text" id="caption">
    <button id="uploadBtn">Upload</button>
  </div>

 
  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const signupSection = document.getElementById('signup');
    const uploadSection = document.getElementById('upload');
    const signupBtn = document.getElementById('signupBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const nameInput = document.getElementById('name');
    const imageInput = document.getElementById('image');
    const captionInput = document.getElementById('caption');

    const userUUID = localStorage.getItem('userUUID');

    if (userUUID) {
      signupSection.style.display = 'none';
      uploadSection.style.display = 'block';
    } else {
      signupBtn.addEventListener('click', async () => {
        const name = nameInput.value;
        const response = await fetch('/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name }),
        });

        const data = await response.json();
        localStorage.setItem('userUUID', data.uuid);

        signupSection.style.display = 'none';
        uploadSection.style.display = 'block';
      });
    }

    uploadBtn.addEventListener('click', async () => {
      const userUUID = localStorage.getItem('userUUID');
      const caption = captionInput.value;
      const formData = new FormData();
      formData.append('image', imageInput.files[0]);
      formData.append('caption', caption);

      const response = await fetch('/upload', {
        method: 'POST',
        headers: { 'x-user-uuid': userUUID },
        body: formData,
      });

      if (response.ok) {
        const data = await response.json();
        alert('Image uploaded successfully. Save it to your camera roll.');
        imageInput.value = '';
        captionInput.value = '';
      } else {
        alert('Error uploading image. Please try again.');
      }
    });
  </script>
</body>
</html> -->

<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Image Uploader</title>
  <link rel="preconnect" href="https://fonts.bunny.net">
  <link href="https://fonts.bunny.net/css?family=aldrich:400|cabin:400,400i,700|caveat-brush:400" rel="stylesheet" />
  <style>
    body {
      background-color: black;
      color: white;
      margin: 0px;
      padding-bottom: env(safe-area-inset-bottom);
      min-height: -webkit-fill-available;
    }

    #video {
      /* width: 100%; */
      /* max-width: 400px; */
      height: 100%;
      /* aspect-ratio: 3.4/2.1; */
      /* padding-bottom: 133.33%; */
    }

    .imageContainer {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      max-width: calc(max(100vh, 100vh) /1.5);
      height: calc(max(100vh, 100vh) - (9vh + 30px));
      /* aspect-ratio: 2.1/3;
      width: 100%; */
      background-color: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: opacity 5s, transform 5s;
      color: black;
      overflow: hidden;
      /* margin: 10px; */
    }


    .caption {
      position: relative;
      height: 9vh;
      padding-top: 10px;
      padding-bottom: 10px;
    }

    .caption input {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 100%;
      font-family: 'Caveat Brush', handwriting;
      font-size: 15ch;
      background-color: #fff;
      border: none;
      outline: none;
      /* padding: 0 10px; */
    }


    .polaroid {
      position: relative;
      overflow: hidden;
      padding: 10px;
      /* padding-bottom: 50px; */
      background-color: white;
      width: -moz-fit-content;
      width: fit-content;
      /* height: fit-content; */
      /* width: 100%; */
      /* transform: scale(calc(100vw / (100vh / 1.5)));
      transform-origin: top left; */


    }

    #polaroid-container {
      transform: translateY(100%);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      width: 100%;
      z-index: 6;
      position: relative;
      /* margin: 30px; */
      height: 100vh;
    }


    .viewfinder {
      /* flex: 1 */
      position: absolute;
      /* max-width: calc(100vh/1.5); */
      max-width: 100vw;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      overflow: hidden;
    }

    .viewfinder-edge {
      position: absolute;
      width: calc(100vh/1.5);
      height: calc(100vh - (9vh + 30px));
      border: 2px solid black;
      z-index: 3;
    }

    .viewfinder-overlay {
      /* content: ""; */
      width: min(20vw, 20vh);
      height: auto;
      aspect-ratio: 1/1;
      border: 2px solid black;
      border-radius: 50%;
      position: absolute;
      /* top: 50%;
      left: 50%;
      transform: translate(-50%, -50%); */
      display: flex;
      flex-direction: column;
      overflow: hidden;
      z-index: 2;
    }

    .viewfinder-overlay .semi {
      flex: 0.5;
      background-color: rgba(0, 0, 0, 0.5);
      -webkit-backdrop-filter: saturate(180%);
      backdrop-filter: saturate(180%);
      /* border-top-right-radius: 50%;
      border-top-left-radius: 50%; */
    }

    .viewfinder-overlay hr {
      margin: 0;
      border: none;
      border-top: 2px solid black;
    }

    #captureBtn {
      position: absolute;
      bottom: 5vw;
      right: 5vw;
      margin-bottom: env(safe-area-inset-bottom);

      background-color: red;
      width: 50px;
      height: 50px;

      border-radius: 50%;
      z-index: 4
    }

    #capturedImage {
      height: 100%;
    }

    #upload {
      /* display: flex; */
      /* flex-direction: column;
      align-items: center;
      justify-content: center; */
      position: relative;
      height: 100vh;
      overflow: hidden;
    }
  </style>
</head>

<body>
  <!-- <h1>Image Uploader</h1> -->
  <code id="error"></code>
  <div id="signup">
    <label for="name">Name:</label>
    <input type="text" id="name">
    <button id="signupBtn">Sign up</button>
  </div>

  <div id="upload" style="display: none;">

    <div id="viewfinder" class="viewfinder">
      <video id="video" autoplay></video>
      <div class="viewfinder-edge"></div>

      <div class="viewfinder-overlay">
        <div class="semi"></div>
        <hr>
      </div>
      <button id="captureBtn"></button>
    </div>
    <div id="polaroid-container">
      <div id="polaroid" class="polaroid">
        <div class="imageContainer">
          <img id="capturedImage" style="display: none;">

        </div>
        <div class="caption"><input type="text" id="caption"></div>
      </div>

    </div>


    <canvas id="canvas" width="1920" height="1080" style="display: none;"></canvas>

    <input type="file" id="image" accept="image/*">
    <label for="caption">Caption:</label>
    <!-- <input type="text" id="caption"> -->
    <button id="uploadBtn">Upload</button>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const signupSection = document.getElementById('signup');
    const uploadSection = document.getElementById('upload');
    const signupBtn = document.getElementById('signupBtn');
    const captureBtn = document.getElementById('captureBtn');
    const uploadBtn = document.getElementById('uploadBtn');
    const nameInput = document.getElementById('name');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const capturedImage = document.getElementById('capturedImage');
    const captionInput = document.getElementById('caption');
    const error = document.getElementById('error');
    const polaroidContainer = document.getElementById('polaroid-container');
    const polaroid = document.getElementById('polaroid');
    video.setAttribute('autoplay', '');
    video.setAttribute('muted', '');
    video.setAttribute('playsinline', '')


    const userUUID = localStorage.getItem('userUUID');

    if (userUUID) {
      signupSection.style.display = 'none';
      uploadSection.style.display = 'block';
      initCamera();
    } else {
      signupBtn.addEventListener('click', async () => {
        const name = nameInput.value;
        const response = await fetch('/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name: name }),
        });

        const data = await response.json();
        localStorage.setItem('userUUID', data.uuid);

        signupSection.style.display = 'none';
        uploadSection.style.display = 'block';
        initCamera();
      });
    }

    async function initCamera() {
      try {

        const stream = await navigator.mediaDevices.getUserMedia({
          video: {
            width: { ideal: 3024 },
            height: { ideal: 4032 }, facingMode: "environment"
          }, audio: false
        });
        console.log(stream)
        const tracks = stream.getVideoTracks()
        console.log("Video Tracks", tracks)
        if (tracks.length == 0) {
          error.innerText = "No Tracks Found"
        }
        video.onloadedmetadata = (e) => {
          video.play();
        };
        video.srcObject = stream;//tracks[0];

      } catch (err) {
        error.innerText = err
        console.error('Error accessing camera:', err);
      }
    }

    captureBtn.addEventListener('click', () => {
      capture()
    });

    function capture() {
      //free data url 
      //animate polaroid to translate 100%
      // polaroid.style.transform = 'translateY(100%)';

      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      capturedImage.src = canvas.toDataURL('image/jpeg');
      capturedImage.style.display = 'block';

      polaroidContainer.animate([
        { transform: 'translateY(100%)' },
        { transform: 'translateY(0%)' }
      ], {
        duration: 5000,
        easing: 'ease-in-out',
        fill: 'forwards'
      });

      const animation = capturedImage.animate([
        { filter: 'sepia(1) saturate(0.1) ', opacity: 0 },
        { filter: 'sepia(0) saturate(1)', opacity: 1 }
      ], {
        // delay:3000,
        duration: 30000,
        easing: 'linear',
        fill: 'forwards'
      });
      setTimeout(() => {
        animation.playbackRate = 11
      }, 5000);

    }

    uploadBtn.addEventListener('click', async () => {
      const userUUID = localStorage.getItem('userUUID');
      const caption = captionInput.value;
      const base64Image = capturedImage.src.split(',')[1];
      const formData = new FormData();
      formData.append('image', base64toBlob(base64Image, 'image/jpeg'), 'image.jpg');
      formData.append('caption', caption);

      const response = await fetch('/upload', {
        method: 'POST',
        headers: { 'x-user-uuid': userUUID },
        body: formData,
      });

      if (response.ok) {
        const data = await response.json();
        alert('Image uploaded successfully. Save it to your camera roll.');
        capturedImage.style.display = 'none';
        captionInput.value = '';
      } else {
        alert('Error uploading image. Please try again.');
      }
    });

    function base64toBlob(base64, mimeType) {
      const byteCharacters = atob(base64);
      const byteArrays = [];

      for (let offset = 0; offset < byteCharacters.length; offset += 512) {
        const slice = byteCharacters.slice(offset, offset + 512);
        const byteNumbers = new Array(slice.length);

        for (let i = 0; i < slice.length; i++) {
          byteNumbers[i] = slice.charCodeAt(i);
        }

        const byteArray = new Uint8Array(byteNumbers);
        byteArrays.push(byteArray);
      }

      return new Blob(byteArrays, { type: mimeType });
    }



    viewfinder.addEventListener('click', () => {
      capture()
    });




    function updatePolaroidScale() {
      
    const windowHeight = window.innerHeight;
    const windowWidth = window.innerWidth;
    const aspectRatio = 1.5; // You can set this to the desired aspect ratio

    const maxPolaroidWidth = windowHeight / aspectRatio;
    const maxPolaroidHeight = windowWidth * aspectRatio;

    const scale = Math.min(windowWidth / maxPolaroidWidth, windowHeight / maxPolaroidHeight);

    polaroid.style.transform = `scale(${scale})`;
    }


  window.addEventListener('resize', updatePolaroidScale);
  document.addEventListener('DOMContentLoaded', updatePolaroidScale);




  let startY = 0;
let deltaY = 0;
let startTime = 0;
let isSwiping = false;
const threshold = 0.4;



function onTouchStart(event) {
  startY = event.touches[0].clientY;
  startTime = new Date().getTime();
  isSwiping = true;
}

function onTouchMove(event) {
  if (!isSwiping) return;
  deltaY = event.touches[0].clientY - startY;
}

function onTouchEnd() {
  if (!isSwiping) return;

  const elapsedTime = new Date().getTime() - startTime;
  const velocity = deltaY / elapsedTime;

  if (-deltaY > threshold * polaroidContainer.offsetHeight) {
    const translateY = `translateY(calc(-100% + ${deltaY}px))`;
    const transition = `transform ${Math.abs(deltaY) / Math.abs(velocity)}ms linear`;

    polaroidContainer.style.transform = translateY;
    polaroidContainer.style.transition = transition;
  }

  isSwiping = false;
}

polaroidContainer.addEventListener('touchstart', onTouchStart);
polaroidContainer.addEventListener('touchmove', onTouchMove);
polaroidContainer.addEventListener('touchend', onTouchEnd);

  </script>
</body>

</html>